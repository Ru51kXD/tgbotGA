# recommendations.py - –ú–æ–¥—É–ª—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è Telegram –±–æ—Ç–∞ GoldenAppleBot
# –≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π 
# –ø–æ –∫–æ—Å–º–µ—Ç–∏–∫–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –∞ —Ç–∞–∫–∂–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–¥–±–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤

# –ò–º–ø–æ—Ä—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ Python
import logging  # –î–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
import json  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞—Ç—Ä–∏–±—É—Ç–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤)
import sqlite3  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å SQLite –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
import random  # –î–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
from datetime import datetime  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏ –∏ –≤—Ä–µ–º–µ–Ω–µ–º
import pandas as pd  # –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–æ–≤
from aiogram import types, Dispatcher  # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ aiogram
from aiogram.fsm.context import FSMContext  # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
from aiogram.fsm.state import State, StatesGroup  # –î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton  # –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
import asyncio  # –î–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á

# –ö–ª–∞—Å—Å —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–¥–±–æ—Ä–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
class RecommendationState(StatesGroup):
    choosing_category = State()  # –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞
    waiting_for_criteria = State()  # –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    choosing_criteria = State()  # –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
    waiting_for_operator_reply = State()  # –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

# –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
user_storage = {}

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ—Ç–≤–µ—Ç–æ–≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
# –ö–ª—é—á - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–Ω–∞—á–µ–Ω–∏–µ - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–ø—Ä–æ—Å–µ –∏ –æ—Ç–≤–µ—Ç–µ
recommendation_requests = {}

# ID —á–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–∑ main.py –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
# –í —ç—Ç–æ—Ç —á–∞—Ç –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –∑–∞–ø—Ä–æ—Å—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –µ—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥–±–æ—Ä –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è
OPERATOR_CHAT_ID = None

def init_db():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    
    –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SQLite —Å–æ —Å–ø–∏—Å–∫–æ–º —Ç–æ–≤–∞—Ä–æ–≤.
    –í —Å–ª—É—á–∞–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –±–∞–∑—ã –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π —Ç–∞–±–ª–∏—Ü—ã, —Å–æ–∑–¥–∞—ë—Ç –µ—ë –∑–∞–Ω–æ–≤–æ –∏
    –∑–∞–ø–æ–ª–Ω—è–µ—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
    
    –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã products:
    - id: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ–≤–∞—Ä–∞
    - name: –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
    - category: –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, mascara, lipstick, perfume)
    - price: —Ü–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞
    - rating: —Ä–µ–π—Ç–∏–Ω–≥ —Ç–æ–≤–∞—Ä–∞ (–æ—Ç 0 –¥–æ 5)
    - attributes: JSON-—Å—Ç—Ä–æ–∫–∞ —Å –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ —Ç–æ–≤–∞—Ä–∞ (—Ç–∏–ø, —ç—Ñ—Ñ–µ–∫—Ç, —Ü–≤–µ—Ç –∏ —Ç.–¥.)
    """
    try:
        import os
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        db_exists = os.path.exists('recommendations.db')
        
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–Ω –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω)
        conn = sqlite3.connect('recommendations.db')
        cursor = conn.cursor()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if db_exists:
            cursor.execute("PRAGMA table_info(products)")
            columns = [col[1] for col in cursor.fetchall()]
            print(f"–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–æ–ª–±—Ü—ã —Ç–∞–±–ª–∏—Ü—ã products: {columns}")
            
            # –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ—Ç —Å—Ç–æ–ª–±—Ü–∞ attributes (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã),
            # —É–¥–∞–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –µ—ë
            if 'attributes' not in columns:
                print("–°—Ç–æ–ª–±–µ—Ü attributes –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É...")
                cursor.execute('DROP TABLE IF EXISTS products')
                db_exists = False
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞
        if not db_exists:
            print("–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É products...")
            cursor.execute('''CREATE TABLE IF NOT EXISTS products
                          (id INTEGER PRIMARY KEY,
                          name TEXT,
                          category TEXT,
                          price REAL,
                          rating REAL,
                          attributes TEXT)''')
            
            # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
            # –ö–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä –∏–º–µ–µ—Ç —Å–≤–æ–π –Ω–∞–±–æ—Ä –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            products = [
                (1, '–¢—É—à—å –¥–ª—è —Ä–µ—Å–Ω–∏—Ü Volume', 'mascara', 1500, 4.8, 
                 json.dumps({
                     "effect": ["volume", "length"],  # –≠—Ñ—Ñ–µ–∫—Ç: –æ–±—ä–µ–º, –¥–ª–∏–Ω–∞
                     "type": "waterproof",  # –¢–∏–ø: –≤–æ–¥–æ—Å—Ç–æ–π–∫–∞—è
                     "brush": "silicone",  # –©–µ—Ç–æ—á–∫–∞: —Å–∏–ª–∏–∫–æ–Ω–æ–≤–∞—è
                     "price": "medium"  # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                (2, '–ü–æ–º–∞–¥–∞ –º–∞—Ç–æ–≤–∞—è Ruby', 'lipstick', 2300, 4.5,
                 json.dumps({
                     "type": "matte",  # –¢–∏–ø: –º–∞—Ç–æ–≤–∞—è
                     "finish": "velvet",  # –§–∏–Ω–∏—à: –±–∞—Ä—Ö–∞—Ç–Ω—ã–π
                     "longevity": "long",  # –°—Ç–æ–π–∫–æ—Å—Ç—å: –¥–æ–ª–≥–∞—è
                     "color": "red",  # –¶–≤–µ—Ç: –∫—Ä–∞—Å–Ω—ã–π
                     "price": "premium"  # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: –ø—Ä–µ–º–∏—É–º
                 })),
                (3, '–ü–∞—Ä—Ñ—é–º Rose Garden', 'perfume', 4500, 4.9,
                 json.dumps({
                     "type": ["floral", "sweet"],  # –¢–∏–ø: —Ü–≤–µ—Ç–æ—á–Ω—ã–π, —Å–ª–∞–¥–∫–∏–π
                     "intensity": "medium",  # –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: —Å—Ä–µ–¥–Ω—è—è
                     "longevity": "long",  # –°—Ç–æ–π–∫–æ—Å—Ç—å: –¥–æ–ª–≥–∞—è
                     "season": ["spring", "summer"],  # –°–µ–∑–æ–Ω: –≤–µ—Å–Ω–∞, –ª–µ—Ç–æ
                     "price": "medium"  # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                (4, '–ü–æ–º–∞–¥–∞ –≥–ª—è–Ω—Ü–µ–≤–∞—è Pearl', 'lipstick', 1800, 4.7,
                 json.dumps({
                     "type": "glossy",  # –¢–∏–ø: –≥–ª—è–Ω—Ü–µ–≤–∞—è
                     "finish": "shimmer",  # –§–∏–Ω–∏—à: —Å —à–∏–º–º–µ—Ä–æ–º
                     "longevity": "medium",  # –°—Ç–æ–π–∫–æ—Å—Ç—å: —Å—Ä–µ–¥–Ω—è—è
                     "color": "nude",  # –¶–≤–µ—Ç: –Ω—é–¥–æ–≤—ã–π
                     "price": "medium"  # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                (5, '–¢—É—à—å –¥–ª—è —Ä–µ—Å–Ω–∏—Ü Dramatic', 'mascara', 2500, 4.6,
                 json.dumps({
                     "effect": ["volume", "curl"],  # –≠—Ñ—Ñ–µ–∫—Ç: –æ–±—ä–µ–º, –ø–æ–¥–∫—Ä—É—á–∏–≤–∞–Ω–∏–µ
                     "type": "waterproof",  # –¢–∏–ø: –≤–æ–¥–æ—Å—Ç–æ–π–∫–∞—è
                     "brush": "curved",  # –©–µ—Ç–æ—á–∫–∞: –∏–∑–æ–≥–Ω—É—Ç–∞—è
                     "price": "premium"  # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: –ø—Ä–µ–º–∏—É–º
                 })),
                (6, '–¢—É—à—å –¥–ª—è —Ä–µ—Å–Ω–∏—Ü Natural Look', 'mascara', 900, 4.3,
                 json.dumps({
                     "effect": ["separation", "definition"],  # –≠—Ñ—Ñ–µ–∫—Ç: —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ, —á–µ—Ç–∫–æ—Å—Ç—å
                     "type": "regular",  # –¢–∏–ø: –æ–±—ã—á–Ω–∞—è
                     "brush": "traditional",  # –©–µ—Ç–æ—á–∫–∞: —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞—è
                     "price": "budget"  # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: –±—é–¥–∂–µ—Ç–Ω–∞—è
                 })),
                (7, '–ü–æ–º–∞–¥–∞ –∂–∏–¥–∫–∞—è Velvet', 'lipstick', 1700, 4.8,
                 json.dumps({
                     "type": "liquid",  # –¢–∏–ø: –∂–∏–¥–∫–∞—è
                     "finish": "velvet",  # –§–∏–Ω–∏—à: –±–∞—Ä—Ö–∞—Ç–Ω—ã–π
                     "longevity": "long",  # –°—Ç–æ–π–∫–æ—Å—Ç—å: –¥–æ–ª–≥–∞—è
                     "color": "berry",  # –¶–≤–µ—Ç: —è–≥–æ–¥–Ω—ã–π
                     "price": "medium"  # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                (8, '–ü–∞—Ä—Ñ—é–º Citrus Fresh', 'perfume', 3500, 4.3,
                 json.dumps({
                     "type": ["citrus", "fresh"],  # –¢–∏–ø: —Ü–∏—Ç—Ä—É—Å–æ–≤—ã–π, —Å–≤–µ–∂–∏–π
                     "intensity": "light",  # –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: –ª–µ–≥–∫–∞—è
                     "longevity": "medium",  # –°—Ç–æ–π–∫–æ—Å—Ç—å: —Å—Ä–µ–¥–Ω—è—è
                     "season": ["summer"],  # –°–µ–∑–æ–Ω: –ª–µ—Ç–æ
                     "price": "medium"  # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                (9, '–¢—É—à—å –¥–ª—è —Ä–µ—Å–Ω–∏—Ü Natural', 'mascara', 900, 4.2,
                 json.dumps({
                     "effect": ["length", "separation"],  # –≠—Ñ—Ñ–µ–∫—Ç: –¥–ª–∏–Ω–∞, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
                     "type": "regular",  # –¢–∏–ø: –æ–±—ã—á–Ω–∞—è
                     "brush": "natural",  # –©–µ—Ç–æ—á–∫–∞: –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è
                     "price": "budget"  # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: –±—é–¥–∂–µ—Ç–Ω–∞—è
                 })),
                (10, '–ü–∞—Ä—Ñ—é–º Tropical Night', 'perfume', 5500, 4.7,
                 json.dumps({
                     "type": ["tropical", "spicy"],  # –¢–∏–ø: —Ç—Ä–æ–ø–∏—á–µ—Å–∫–∏–π, –ø—Ä—è–Ω—ã–π
                     "intensity": "strong",  # –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: —Å–∏–ª—å–Ω–∞—è
                     "longevity": "long",  # –°—Ç–æ–π–∫–æ—Å—Ç—å: –¥–æ–ª–≥–∞—è
                     "season": ["summer", "autumn"],  # –°–µ–∑–æ–Ω: –ª–µ—Ç–æ, –æ—Å–µ–Ω—å
                     "price": "premium"  # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: –ø—Ä–µ–º–∏—É–º
                 })),
                # –†—É–º—è–Ω–∞
                (11, '–†—É–º—è–Ω–∞ –≥–µ–ª–µ–≤—ã–µ Rose Glow', 'blush', 2500, 4.6,
                 json.dumps({
                     "texture": "gel",  # –¢–µ–∫—Å—Ç—É—Ä–∞: –≥–µ–ª–µ–≤—ã–µ
                     "color": "nude",   # –¶–≤–µ—Ç: –Ω—é–¥–æ–≤—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏
                     "price": "medium"  # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                (12, '–†—É–º—è–Ω–∞ –ø—É–¥—Ä–æ–≤—ã–µ Bright Berry', 'blush', 3200, 4.4,
                 json.dumps({
                     "texture": "powder",  # –¢–µ–∫—Å—Ç—É—Ä–∞: –ø—É–¥—Ä–æ–≤—ã–µ
                     "color": "bright",    # –¶–≤–µ—Ç: —è—Ä–∫–∏–µ –æ—Ç—Ç–µ–Ω–∫–∏
                     "price": "medium"     # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                (13, '–†—É–º—è–Ω–∞ –∫—Ä–µ–º–æ–≤—ã–µ Peachy', 'blush', 2800, 4.7,
                 json.dumps({
                     "texture": "cream",  # –¢–µ–∫—Å—Ç—É—Ä–∞: –∫—Ä–µ–º–æ–≤—ã–µ
                     "color": "nude",     # –¶–≤–µ—Ç: –Ω—é–¥–æ–≤—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏
                     "price": "medium"    # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                # –•–∞–π–ª–∞–π—Ç–µ—Ä
                (14, '–•–∞–π–ª–∞–π—Ç–µ—Ä –∂–∏–¥–∫–∏–π Golden Glow', 'highlighter', 3500, 4.8,
                 json.dumps({
                     "texture": "liquid",  # –¢–µ–∫—Å—Ç—É—Ä–∞: –∂–∏–¥–∫–∏–π
                     "shade": "warm",      # –û—Ç—Ç–µ–Ω–∫–∏: —Ç–µ–ø–ª—ã–µ
                     "price": "medium"     # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                (15, '–•–∞–π–ª–∞–π—Ç–µ—Ä —Å—Ç–∏–∫ Silver Light', 'highlighter', 2900, 4.5,
                 json.dumps({
                     "texture": "stick",  # –¢–µ–∫—Å—Ç—É—Ä–∞: —Å—Ç–∏–∫
                     "shade": "cool",     # –û—Ç—Ç–µ–Ω–∫–∏: —Ö–æ–ª–æ–¥–Ω—ã–µ
                     "price": "medium"    # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                (16, '–•–∞–π–ª–∞–π—Ç–µ—Ä –ø—É–¥—Ä–æ–≤—ã–π Pearl Shine', 'highlighter', 3800, 4.9,
                 json.dumps({
                     "texture": "powder",  # –¢–µ–∫—Å—Ç—É—Ä–∞: –ø—É–¥—Ä–æ–≤—ã–π
                     "shade": "warm",      # –û—Ç—Ç–µ–Ω–∫–∏: —Ç–µ–ø–ª—ã–µ
                     "price": "medium"     # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                # –ü—É–¥—Ä–∞
                (17, '–ü—É–¥—Ä–∞ —Ä–∞—Å—Å—ã–ø—á–∞—Ç–∞—è Transparent', 'powder', 2200, 4.3,
                 json.dumps({
                     "texture": "loose",      # –¢–µ–∫—Å—Ç—É—Ä–∞: —Ä–∞—Å—Å—ã–ø—á–∞—Ç–∞—è
                     "shade": "transparent",  # –û—Ç—Ç–µ–Ω–∫–∏: –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è
                     "price": "medium"        # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                (18, '–ü—É–¥—Ä–∞ –ø—Ä–µ—Å—Å–æ–≤–∞–Ω–Ω–∞—è Beige', 'powder', 2700, 4.6,
                 json.dumps({
                     "texture": "pressed",  # –¢–µ–∫—Å—Ç—É—Ä–∞: –ø—Ä–µ—Å—Å–æ–≤–∞–Ω–Ω–∞—è
                     "shade": "tinted",     # –û—Ç—Ç–µ–Ω–∫–∏: —Ç–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è
                     "price": "medium"      # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                # –¢–µ–Ω–∏
                (19, '–¢–µ–Ω–∏ —Å—É—Ö–∏–µ Nude Palette', 'eyeshadow', 2400, 4.5,
                 json.dumps({
                     "texture": "dry",    # –¢–µ–∫—Å—Ç—É—Ä–∞: —Å—É—Ö–∏–µ
                     "shade": "nude",     # –û—Ç—Ç–µ–Ω–∫–∏: –Ω—é–¥–æ–≤—ã–µ
                     "price": "medium"    # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                (20, '–¢–µ–Ω–∏ –∂–∏–¥–∫–∏–µ Bright Color', 'eyeshadow', 3100, 4.7,
                 json.dumps({
                     "texture": "liquid",  # –¢–µ–∫—Å—Ç—É—Ä–∞: –∂–∏–¥–∫–∏–µ
                     "shade": "bright",    # –û—Ç—Ç–µ–Ω–∫–∏: —è—Ä–∫–∏–µ
                     "price": "medium"     # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 })),
                (21, '–¢–µ–Ω–∏ —Å—É—Ö–∏–µ Smoky Eyes', 'eyeshadow', 2800, 4.8,
                 json.dumps({
                     "texture": "dry",    # –¢–µ–∫—Å—Ç—É—Ä–∞: —Å—É—Ö–∏–µ
                     "shade": "bright",   # –û—Ç—Ç–µ–Ω–∫–∏: —è—Ä–∫–∏–µ
                     "price": "medium"    # –¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è: —Å—Ä–µ–¥–Ω—è—è
                 }))
            ]
            
            # –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É
            cursor.executemany('INSERT INTO products VALUES (?,?,?,?,?,?)', products)
            conn.commit()
            print(f"–î–æ–±–∞–≤–ª–µ–Ω–æ {len(products)} —Ç–æ–≤–∞—Ä–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ products
        cursor.execute("SELECT COUNT(*) FROM products")
        row_count = cursor.fetchone()[0]
        print(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: {row_count}")
        
        conn.close()
    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        logging.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î: {e}")
        # –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞, –ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∑–∞–Ω–æ–≤–æ
        try:
            import os
            # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if os.path.exists('recommendations.db'):
                os.remove('recommendations.db')
            
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
            conn = sqlite3.connect('recommendations.db')
            cursor = conn.cursor()
            cursor.execute('''CREATE TABLE IF NOT EXISTS products
                          (id INTEGER PRIMARY KEY,
                          name TEXT,
                          category TEXT,
                          price REAL,
                          rating REAL,
                          attributes TEXT)''')
            conn.commit()
            conn.close()
            print("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∞ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏")
        except Exception as inner_e:
            # –õ–æ–≥–∏—Ä—É–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            logging.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {inner_e}")
            print(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {inner_e}")

def get_category_criteria_keyboard(category: str, selected_criteria: list = None) -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
    
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
    –í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ç–º–µ—á–∞—é—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º —Å–∏–º–≤–æ–ª–æ–º.
    
    Args:
        category (str): –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞ (mascara, lipstick, perfume –∏ —Ç.–¥.)
        selected_criteria (list, optional): –°–ø–∏—Å–æ–∫ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
        
    Returns:
        InlineKeyboardMarkup: –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
    """
    if selected_criteria is None:
        selected_criteria = []
    
    # –ü–æ–ª—É—á–∞–µ–º –∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞ ProductCategories
    category_data = getattr(ProductCategories, category.upper(), {})
    
    buttons = []
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–º–∞–π–ª–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≥—Ä—É–ø–ø –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞
    emoji_map = {
        "type": "üè∑Ô∏è",  # –¢–∏–ø
        "effect": "‚ú®",  # –≠—Ñ—Ñ–µ–∫—Ç
        "finish": "üé®",  # –§–∏–Ω–∏—à
        "longevity": "‚è±Ô∏è",  # –°—Ç–æ–π–∫–æ—Å—Ç—å
        "color": "üåà",  # –¶–≤–µ—Ç
        "brush": "üñåÔ∏è",  # –©–µ—Ç–æ—á–∫–∞
        "price": "üí∞",  # –¶–µ–Ω–∞
        "intensity": "üí™",  # –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
        "season": "üçÉ",   # –°–µ–∑–æ–Ω
        "texture": "üè∑Ô∏è",  # –¢–µ–∫—Å—Ç—É—Ä–∞
        "shade": "üåà"   # –û—Ç—Ç–µ–Ω–∫–∏
    }
    
    # –î–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ —Å–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∏
    for criteria_group, criteria_values in category_data.items():
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–ø—ã –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ —Å —ç–º–æ–¥–∑–∏
        group_emoji = emoji_map.get(criteria_group, "üìã")
        buttons.append([InlineKeyboardButton(
            text=f"{group_emoji} {criteria_group.title()}",
            callback_data=f"header_{criteria_group}"
        )])
        
        # –ö–Ω–æ–ø–∫–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
        criteria_buttons = []
        for criteria_id, criteria_name in criteria_values.items():
            # –í—ã–±—Ä–∞–Ω –ª–∏ —ç—Ç–æ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–π
            is_selected = f"{criteria_group}_{criteria_id}" in selected_criteria
            marker = "‚úÖ " if is_selected else "‚¨ú "
            criteria_emoji = ""
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —ç–º–æ–¥–∑–∏ –¥–ª—è –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
            if criteria_group == "type":
                if criteria_id == "matte": criteria_emoji = "üé≠ "
                elif criteria_id == "glossy": criteria_emoji = "‚ú® "
                elif criteria_id == "liquid": criteria_emoji = "üíß "
                elif criteria_id == "satin": criteria_emoji = "üßµ "
                elif criteria_id == "waterproof": criteria_emoji = "üí¶ "
                elif criteria_id == "regular": criteria_emoji = "üìè "
                elif criteria_id == "floral": criteria_emoji = "üå∏ "
                elif criteria_id == "citrus": criteria_emoji = "üçä "
                elif criteria_id == "woody": criteria_emoji = "üå≤ "
                elif criteria_id == "spicy": criteria_emoji = "üå∂Ô∏è "
                elif criteria_id == "sweet": criteria_emoji = "üç¨ "
                elif criteria_id == "fresh": criteria_emoji = "‚ùÑÔ∏è "
            elif criteria_group == "effect":
                if criteria_id == "volume": criteria_emoji = "üîù "
                elif criteria_id == "length": criteria_emoji = "üìè "
                elif criteria_id == "curl": criteria_emoji = "‚Ü™Ô∏è "
                elif criteria_id == "separation": criteria_emoji = "üîÄ "
            elif criteria_group == "finish":
                if criteria_id == "velvet": criteria_emoji = "üß∏ "
                elif criteria_id == "shimmer": criteria_emoji = "‚ú® "
                elif criteria_id == "cream": criteria_emoji = "üç¶ "
            elif criteria_group == "longevity":
                if criteria_id == "short": criteria_emoji = "‚è±Ô∏è "
                elif criteria_id == "medium": criteria_emoji = "‚è≤Ô∏è "
                elif criteria_id == "long": criteria_emoji = "‚è∞ "
            elif criteria_group == "color":
                if criteria_id == "nude": criteria_emoji = "ü§é "
                elif criteria_id == "red": criteria_emoji = "‚ù§Ô∏è "
                elif criteria_id == "berry": criteria_emoji = "üçì "
                elif criteria_id == "pink": criteria_emoji = "üíó "
                elif criteria_id == "bright": criteria_emoji = "üåü "
            elif criteria_group == "brush":
                if criteria_id == "silicone": criteria_emoji = "üî¨ "
                elif criteria_id == "curved": criteria_emoji = "‚Ü™Ô∏è "
                elif criteria_id == "traditional": criteria_emoji = "üñåÔ∏è "
            elif criteria_group == "price":
                if criteria_id == "budget": criteria_emoji = "üí∏ "
                elif criteria_id == "medium": criteria_emoji = "üíµ "
                elif criteria_id == "premium": criteria_emoji = "üíé "
            elif criteria_group == "intensity":
                if criteria_id == "light": criteria_emoji = "üïØÔ∏è "
                elif criteria_id == "medium": criteria_emoji = "üí° "
                elif criteria_id == "strong": criteria_emoji = "üîÜ "
            elif criteria_group == "season":
                if criteria_id == "spring": criteria_emoji = "üå± "
                elif criteria_id == "summer": criteria_emoji = "‚òÄÔ∏è "
                elif criteria_id == "autumn": criteria_emoji = "üçÇ "
                elif criteria_id == "winter": criteria_emoji = "‚ùÑÔ∏è "
            elif criteria_group == "texture":
                if criteria_id == "gel": criteria_emoji = "üß¥ "
                elif criteria_id == "powder": criteria_emoji = "üíé "
                elif criteria_id == "cream": criteria_emoji = "üç¶ "
                elif criteria_id == "liquid": criteria_emoji = "üíß "
                elif criteria_id == "stick": criteria_emoji = "üñçÔ∏è "
                elif criteria_id == "loose": criteria_emoji = "üí® "
                elif criteria_id == "pressed": criteria_emoji = "‚¨ú "
                elif criteria_id == "dry": criteria_emoji = "üå™Ô∏è "
            elif criteria_group == "shade":
                if criteria_id == "cool": criteria_emoji = "‚ùÑÔ∏è "
                elif criteria_id == "warm": criteria_emoji = "üî• "
                elif criteria_id == "transparent": criteria_emoji = "üëª "
                elif criteria_id == "tinted": criteria_emoji = "üé® "
                
            criteria_buttons.append(InlineKeyboardButton(
                text=f"{marker}{criteria_emoji}{criteria_name}",
                callback_data=f"criteria_{category}_{criteria_group}_{criteria_id}"
            ))
            
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –ø–æ 2 –≤ —Ä—è–¥
        row = []
        for button in criteria_buttons:
            row.append(button)
            if len(row) == 2:
                buttons.append(row)
                row = []
        if row:  # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∫–Ω–æ–ø–∫–∏
            buttons.append(row)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    buttons.extend([
        [InlineKeyboardButton(text="‚ú® –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏", callback_data=f"show_recommendations_{category}")],
        [InlineKeyboardButton(text="üîÑ –°–±—Ä–æ—Å–∏—Ç—å", callback_data=f"reset_criteria_{category}")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="back_to_categories")]
    ])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)

async def get_user_data(user_id: int) -> dict:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    
    –ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö.
    –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ—ë. –ï—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ—Ç –ø—É—Å—Ç—É—é –∑–∞–ø–∏—Å—å.
    
    Args:
        user_id (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
        
    Returns:
        dict: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤–∫–ª—é—á–∞—é—â–∏–π –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤,
              –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
    """
    return user_storage.get(user_id, {
        'view_history': [],  # –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        'purchase_history': [],  # –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        'preferences': {}  # –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏)
    })

# –ö–ª–∞—Å—Å —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –∏—Ö –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏
class ProductCategories:
    # –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç—É—à–∏
    MASCARA = {
        "effect": {
            "volume": "–û–±—ä–µ–º —Ä–µ—Å–Ω–∏—Ü",
            "length": "–£–¥–ª–∏–Ω–µ–Ω–∏–µ —Ä–µ—Å–Ω–∏—Ü",
            "curl": "–ü–æ–¥–∫—Ä—É—á–∏–≤–∞–Ω–∏–µ —Ä–µ—Å–Ω–∏—Ü",
            "separation": "–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ä–µ—Å–Ω–∏—Ü"
        },
        "type": {
            "waterproof": "–í–æ–¥–æ—Å—Ç–æ–π–∫–∞—è",
            "regular": "–û–±—ã—á–Ω–∞—è",
            "fibrous": "–° —Ñ–∏–±—Ä–∞–º–∏"
        },
        "brush": {
            "silicone": "–°–∏–ª–∏–∫–æ–Ω–æ–≤–∞—è —â–µ—Ç–æ—á–∫–∞",
            "curved": "–ò–∑–æ–≥–Ω—É—Ç–∞—è —â–µ—Ç–æ—á–∫–∞",
            "traditional": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —â–µ—Ç–æ—á–∫–∞"
        },
        "price": {
            "budget": "–ë—é–¥–∂–µ—Ç–Ω–∞—è (–¥–æ 1000—Ä)",
            "medium": "–°—Ä–µ–¥–Ω—è—è (1000-2000—Ä)",
            "premium": "–ü—Ä–µ–º–∏—É–º (–æ—Ç 2000—Ä)"
        }
    }

    # –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ–º–∞–¥—ã
    LIPSTICK = {
        "type": {
            "matte": "–ú–∞—Ç–æ–≤–∞—è",
            "glossy": "–ì–ª—è–Ω—Ü–µ–≤–∞—è",
            "liquid": "–ñ–∏–¥–∫–∞—è",
            "satin": "–°–∞—Ç–∏–Ω–æ–≤–∞—è"
        },
        "finish": {
            "velvet": "–ë–∞—Ä—Ö–∞—Ç–Ω—ã–π —Ñ–∏–Ω–∏—à",
            "shimmer": "–° —à–∏–º–º–µ—Ä–æ–º",
            "cream": "–ö—Ä–µ–º–æ–≤—ã–π —Ñ–∏–Ω–∏—à"
        },
        "longevity": {
            "short": "–û–±—ã—á–Ω–∞—è —Å—Ç–æ–π–∫–æ—Å—Ç—å",
            "medium": "–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–π–∫–æ—Å—Ç—å",
            "long": "–î–æ–ª–≥–∞—è —Å—Ç–æ–π–∫–æ—Å—Ç—å"
        },
        "color": {
            "nude": "–ù—é–¥–æ–≤—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏",
            "red": "–ö—Ä–∞—Å–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏",
            "berry": "–Ø–≥–æ–¥–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏",
            "pink": "–†–æ–∑–æ–≤—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏"
        }
    }

    # –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–∞—Ä—Ñ—é–º–∞ –∏ –µ—ë –∫—Ä–∏—Ç–µ—Ä–∏–∏
    PERFUME = {
        "type": {  # –ì—Ä—É–ø–ø–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤: —Ç–∏–ø –∞—Ä–æ–º–∞—Ç–∞
            "floral": "–¶–≤–µ—Ç–æ—á–Ω—ã–µ",
            "citrus": "–¶–∏—Ç—Ä—É—Å–æ–≤—ã–µ",
            "woody": "–î—Ä–µ–≤–µ—Å–Ω—ã–µ",
            "spicy": "–ü—Ä—è–Ω—ã–µ",
            "sweet": "–°–ª–∞–¥–∫–∏–µ",
            "fresh": "–°–≤–µ–∂–∏–µ"
        },
        "intensity": {  # –ì—Ä—É–ø–ø–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤: –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –∞—Ä–æ–º–∞—Ç–∞
            "light": "–õ–µ–≥–∫–∞—è",
            "medium": "–°—Ä–µ–¥–Ω—è—è",
            "strong": "–°–∏–ª—å–Ω–∞—è"
        },
        "longevity": {  # –ì—Ä—É–ø–ø–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤: —Å—Ç–æ–π–∫–æ—Å—Ç—å –∞—Ä–æ–º–∞—Ç–∞
            "short": "–û–±—ã—á–Ω–∞—è —Å—Ç–æ–π–∫–æ—Å—Ç—å",
            "medium": "–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–π–∫–æ—Å—Ç—å",
            "long": "–î–æ–ª–≥–∞—è —Å—Ç–æ–π–∫–æ—Å—Ç—å"
        },
        "season": {  # –ì—Ä—É–ø–ø–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤: —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –∞—Ä–æ–º–∞—Ç–∞
            "spring": "–í–µ—Å–µ–Ω–Ω–∏–π",
            "summer": "–õ–µ—Ç–Ω–∏–π",
            "autumn": "–û—Å–µ–Ω–Ω–∏–π",
            "winter": "–ó–∏–º–Ω–∏–π"
        },
        "price": {  # –ì—Ä—É–ø–ø–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤: —Ü–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
            "budget": "–ë—é–¥–∂–µ—Ç–Ω–∞—è (–¥–æ 3000—Ä)",
            "medium": "–°—Ä–µ–¥–Ω—è—è (3000-5000—Ä)",
            "premium": "–ü—Ä–µ–º–∏—É–º (–æ—Ç 5000—Ä)"
        }
    }

    # –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä—É–º—è–Ω
    BLUSH = {
        "texture": {
            "gel": "–ì–µ–ª–µ–≤—ã–µ",
            "powder": "–ü—É–¥—Ä–æ–≤—ã–µ", 
            "cream": "–ö—Ä–µ–º–æ–≤—ã–µ"
        },
        "color": {
            "nude": "–ù—é–¥–æ–≤—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏",
            "bright": "–Ø—Ä–∫–∏–µ –æ—Ç—Ç–µ–Ω–∫–∏"
        },
        "price": {
            "medium": "–°—Ä–µ–¥–Ω—è—è (2000-10000—Ä)"
        }
    }

    # –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ö–∞–π–ª–∞–π—Ç–µ—Ä–∞
    HIGHLIGHTER = {
        "texture": {
            "liquid": "–ñ–∏–¥–∫–∏–π",
            "stick": "–°—Ç–∏–∫",
            "powder": "–ü—É–¥—Ä–æ–≤—ã–π"
        },
        "shade": {
            "cool": "–•–æ–ª–æ–¥–Ω—ã–µ",
            "warm": "–¢–µ–ø–ª—ã–µ"
        },
        "price": {
            "medium": "–°—Ä–µ–¥–Ω—è—è (2000-10000—Ä)"
        }
    }

    # –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—É–¥—Ä—ã
    POWDER = {
        "texture": {
            "loose": "–†–∞—Å—Å—ã–ø—á–∞—Ç–∞—è",
            "pressed": "–ü—Ä–µ—Å—Å–æ–≤–∞–Ω–Ω–∞—è"
        },
        "shade": {
            "transparent": "–ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è",
            "tinted": "–¢–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è"
        },
        "price": {
            "medium": "–°—Ä–µ–¥–Ω—è—è (2000-10000—Ä)"
        }
    }

    # –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–µ–Ω–µ–π
    EYESHADOW = {
        "texture": {
            "dry": "–°—É—Ö–∏–µ",
            "liquid": "–ñ–∏–¥–∫–∏–µ"
        },
        "shade": {
            "bright": "–Ø—Ä–∫–∏–µ",
            "nude": "–ù—é–¥–æ–≤—ã–µ"
        },
        "price": {
            "medium": "–°—Ä–µ–¥–Ω—è—è (2000-10000—Ä)"
        }
    }

# –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
class RecommendationSystem:
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Å–∏—Å—Ç–µ–º—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
    
    –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º.
    """
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        
        –°–æ–∑–¥–∞–µ—Ç –ø—É—Å—Ç—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–∞—Ö.
        –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ.
        """
        self.products = []  # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
        self.products_by_category = {}  # –°–ª–æ–≤–∞—Ä—å —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        self.data_loaded = False  # –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        
    def load_data(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        
        –ó–∞–ø–æ–ª–Ω—è–µ—Ç self.products –∏ self.products_by_category –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î.
        –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è.
        """
        if self.data_loaded:
            return
        
        try:
            # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            conn = sqlite3.connect('recommendations.db')
            cursor = conn.cursor()
            cursor.execute("SELECT id, name, category, price, rating, attributes FROM products")
            rows = cursor.fetchall()
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
            for row in rows:
                product_id, name, category, price, rating, attributes_json = row
                try:
                    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º JSON —Å—Ç—Ä–æ–∫—É –∏–∑ –ë–î –≤ —Å–ª–æ–≤–∞—Ä—å Python
                    attributes = json.loads(attributes_json) if attributes_json else {}
                except json.JSONDecodeError as e:
                    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å
                    print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ JSON –¥–ª—è —Ç–æ–≤–∞—Ä–∞ {product_id}: {e}")
                    attributes = {}
                
                # –°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–≤–∞—Ä–µ
                product = {
                    'id': product_id,
                    'name': name,
                    'category': category,
                    'price': price,
                    'rating': rating,
                    'attributes': attributes
                }
                
                # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫
                self.products.append(product)
                
                # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –≤ —Å–ª–æ–≤–∞—Ä—å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                if category not in self.products_by_category:
                    self.products_by_category[category] = []
                self.products_by_category[category].append(product)
            
            conn.close()
            self.data_loaded = True
            print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self.products)} —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
        
        except Exception as e:
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î: {e}")
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: {e}")
    
    def refresh_data(self):
        """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        
        –û—á–∏—â–∞–µ—Ç –∫–µ—à –∏ –∑–∞–Ω–æ–≤–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã.
        """
        self.products = []
        self.products_by_category = {}
        self.data_loaded = False
        self.load_data()
    
    def get_recommendations_by_popularity(self, category=None, limit=5):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏
        
        –í—ã–±–∏—Ä–∞–µ—Ç —Ç–æ–≤–∞—Ä—ã —Å –Ω–∞–∏–≤—ã—Å—à–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
        
        Args:
            category (str, optional): –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.
                                      –ï—Å–ª–∏ None, –≤—ã–±–∏—Ä–∞—é—Ç—Å—è —Ç–æ–≤–∞—Ä—ã –∏–∑ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
            limit (int, optional): –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 5.
            
        Returns:
            list: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞—Ö.
        """
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        self.load_data()
        
        # –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–ª–∏ –∏–∑ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        if category:
            products = self.products_by_category.get(category, [])
        else:
            products = self.products
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É (–æ—Ç –≤—ã—Å—à–µ–≥–æ –∫ –Ω–∏–∑—à–µ–º—É)
        sorted_products = sorted(products, key=lambda x: x['rating'], reverse=True)
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ª–∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
        return sorted_products[:limit]
    
    def get_recommendations_by_price(self, category=None, limit=5, ascending=True):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ü–µ–Ω—ã
        
        –í—ã–±–∏—Ä–∞–µ—Ç —Ç–æ–≤–∞—Ä—ã —Å –Ω–∞–∏–º–µ–Ω—å—à–µ–π –∏–ª–∏ –Ω–∞–∏–±–æ–ª—å—à–µ–π —Ü–µ–Ω–æ–π –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
        
        Args:
            category (str, optional): –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.
                                      –ï—Å–ª–∏ None, –≤—ã–±–∏—Ä–∞—é—Ç—Å—è —Ç–æ–≤–∞—Ä—ã –∏–∑ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
            limit (int, optional): –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 5.
            ascending (bool, optional): –ï—Å–ª–∏ True, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é —Ü–µ–Ω—ã (–æ—Ç –¥–µ—à–µ–≤—ã—Ö).
                                        –ï—Å–ª–∏ False, –ø–æ —É–±—ã–≤–∞–Ω–∏—é (–æ—Ç –¥–æ—Ä–æ–≥–∏—Ö).
            
        Returns:
            list: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞—Ö.
        """
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        self.load_data()
        
        # –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–ª–∏ –∏–∑ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        if category:
            products = self.products_by_category.get(category, [])
        else:
            products = self.products
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ —Ü–µ–Ω–µ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –∏–ª–∏ —É–±—ã–≤–∞–Ω–∏—é)
        sorted_products = sorted(products, key=lambda x: x['price'], reverse=not ascending)
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ª–∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
        return sorted_products[:limit]

# –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
class AdvancedRecommendationSystem:
    """–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º
    
    –≠—Ç–æ—Ç –∫–ª–∞—Å—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö
    –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º. –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±–æ–ª–µ–µ –≥–∏–±–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞.
    """
    
    def get_recommendations(self, category: str, criteria: list) -> list:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Å–ø–∏—Å–∫—É –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
        
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–≤–∞—Ä—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ 
        –≤—Å–µ–º —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
        
        Args:
            category (str): –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ (mascara, lipstick, perfume –∏ —Ç.–¥.)
            criteria (list): –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ —Å –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–≥—Ä—É–ø–ø–∞_–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä"
                            (–Ω–∞–ø—Ä–∏–º–µ—Ä, ["type_matte", "price_premium"])
            
        Returns:
            list: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞—Ö
        """
        # –í—ã–≤–æ–¥ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—ã–∑–æ–≤–æ–≤
        print(f"–ü–æ–∏—Å–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {category}, –∫—Ä–∏—Ç–µ—Ä–∏–∏: {criteria}")
        
        # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQLite
        conn = sqlite3.connect('recommendations.db')
        cursor = conn.cursor()
        
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã products –∏ –Ω–∞–ª–∏—á–∏–µ —Å—Ç–æ–ª–±—Ü–∞ attributes
            # –≠—Ç–æ –≤–∞–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –∫—Ä–∏—Ç–µ—Ä–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ –≤ —ç—Ç–æ–º —Å—Ç–æ–ª–±—Ü–µ
            cursor.execute("PRAGMA table_info(products)")
            columns = [col[1] for col in cursor.fetchall()]
            print(f"–°—Ç–æ–ª–±—Ü—ã —Ç–∞–±–ª–∏—Ü—ã products: {columns}")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–π SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—ã–±–æ—Ä–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞–¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            query = f"SELECT * FROM products WHERE category = ?"
            params = [category]
            
            # –ï—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –µ—Å—Ç—å —Å—Ç–æ–ª–±–µ—Ü attributes –∏ –∑–∞–¥–∞–Ω—ã –∫—Ä–∏—Ç–µ—Ä–∏–∏,
            # —Ä–∞—Å—à–∏—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ LIKE –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—Ä–∏—Ç–µ—Ä–∏—è
            # –ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ –≤—Ö–æ–∂–¥–µ–Ω–∏—é –∫—Ä–∏—Ç–µ—Ä–∏—è –≤ JSON —Å—Ç—Ä–æ–∫—É –∞—Ç—Ä–∏–±—É—Ç–æ–≤
            if 'attributes' in columns and criteria:
                query += " AND " + " AND ".join(["attributes LIKE ?" for _ in criteria])
                params += [f'%{c}%' for c in criteria]
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º SQL –∑–∞–ø—Ä–æ—Å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            print(f"SQL –∑–∞–ø—Ä–æ—Å: {query}")
            print(f"–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {params}")
            cursor.execute(query, params)
            
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–∞
            rows = cursor.fetchall()
            print(f"–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {len(rows)}")
            
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            results = self._parse_results(rows, columns)
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–∞–π–¥–µ–Ω—ã, –∏–ª–∏ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
            return results
        
        except Exception as e:
            # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {e}")
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {e}")
            return []
        
        finally:
            # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
            conn.close()

    def _parse_results(self, rows, columns) -> list:
        """–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã SQL –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π
        
        Args:
            rows (list): –°–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∑–∞–ø—Ä–æ—Å–∞
            columns (list): –°–ø–∏—Å–æ–∫ –∏–º–µ–Ω —Å—Ç–æ–ª–±—Ü–æ–≤ —Ç–∞–±–ª–∏—Ü—ã
            
        Returns:
            list: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –æ —Ç–æ–≤–∞—Ä–∞—Ö
        """
        results = []
        
        # –ò–Ω–¥–µ–∫—Å —Å—Ç–æ–ª–±—Ü–∞ attributes –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        attributes_idx = columns.index('attributes') if 'attributes' in columns else -1
        
        for row in rows:
            # –°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å —Ç–æ–≤–∞—Ä–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞
            item = {}
            for i, col in enumerate(columns):
                if i < len(row):
                    item[col] = row[i]
            
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º JSON —Å—Ç—Ä–æ–∫—É –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ —Å–ª–æ–≤–∞—Ä—å Python
            if attributes_idx >= 0 and attributes_idx < len(row) and row[attributes_idx]:
                try:
                    item['attributes'] = json.loads(row[attributes_idx])
                except (json.JSONDecodeError, TypeError) as e:
                    print(f"–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON –¥–ª—è —Ç–æ–≤–∞—Ä–∞: {e}")
                    item['attributes'] = {}
            else:
                item['attributes'] = {}
            
            results.append(item)
        
        return results
    
    def get_random_recommendations(self, category, limit=3):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –∏–ª–∏ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.
        
        Args:
            category (str): –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–æ–≤ (mascara, lipstick, perfume –∏ —Ç.–¥.)
            limit (int, optional): –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 3.
            
        Returns:
            list: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–ª—É—á–∞–π–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞—Ö
        """
        conn = sqlite3.connect('recommendations.db')
        cursor = conn.cursor()
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            cursor.execute("PRAGMA table_info(products)")
            columns = [col[1] for col in cursor.fetchall()]
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å —Å —Å–ª—É—á–∞–π–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            cursor.execute(
                "SELECT * FROM products WHERE category = ? ORDER BY RANDOM() LIMIT ?", 
                (category, limit)
            )
            
            results = cursor.fetchall()
            return self._parse_results(results, columns)
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ª—É—á–∞–π–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {e}")
            print(f"–û—à–∏–±–∫–∞: {e}")
            return []
            
        finally:
            conn.close()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–∞–ª–µ–µ)
recommendation_system = AdvancedRecommendationSystem()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ —Ç–æ–≤–∞—Ä–æ–≤
def get_categories_keyboard() -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ —Ç–æ–≤–∞—Ä–æ–≤
    
    Returns:
        InlineKeyboardMarkup: –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    """
    buttons = [
        [
            InlineKeyboardButton(text="üíÑ –ü–æ–º–∞–¥–∞", callback_data="select_category_lipstick"),
            InlineKeyboardButton(text="üëÅ –¢—É—à—å", callback_data="select_category_mascara")
        ],
        [
            InlineKeyboardButton(text="üß¥ –ü–∞—Ä—Ñ—é–º", callback_data="select_category_perfume"),
            InlineKeyboardButton(text="üå∏ –†—É–º—è–Ω–∞", callback_data="select_category_blush")
        ],
        [
            InlineKeyboardButton(text="‚ú® –•–∞–π–ª–∞–π—Ç–µ—Ä", callback_data="select_category_highlighter"),
            InlineKeyboardButton(text="üåü –ü—É–¥—Ä–∞", callback_data="select_category_powder")
        ],
        [
            InlineKeyboardButton(text="üëÄ –¢–µ–Ω–∏", callback_data="select_category_eyeshadow"),
            InlineKeyboardButton(text="üîç –î—Ä—É–≥–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", callback_data="more_categories")
        ],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
    ]
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
def format_recommendation(product: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    
    Args:
        product (dict): –°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–≤–∞—Ä–µ
        
    Returns:
        str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–≤–∞—Ä–µ
    """
    # –ü–æ–ª—É—á–∞–µ–º —ç–º–æ–¥–∑–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞
    category_emoji = {
        'lipstick': 'üíÑ',
        'mascara': 'üëÅ',
        'perfume': 'üß¥',
        'blush': 'üå∏',
        'highlighter': '‚ú®',
        'powder': 'üåü',
        'eyeshadow': 'üëÄ'
    }
    emoji = category_emoji.get(product['category'], 'üéÄ')
    
    # –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏ —Ü–µ–Ω–æ–π
    text = f"{emoji} <b>{product['name']}</b>\n"
    text += f"üí∞ –¶–µ–Ω–∞: {product['price']} ‚ÇΩ\n"
    text += f"‚≠ê –†–µ–π—Ç–∏–Ω–≥: {product['rating']} / 5.0\n\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞—Ç—Ä–∏–±—É—Ç–∞—Ö —Ç–æ–≤–∞—Ä–∞, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if 'attributes' in product and product['attributes']:
        text += "<b>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</b>\n"
        
        # –°–ª–æ–≤–∞—Ä—å —Å —Ä—É—Å—Å–∫–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –≥—Ä—É–ø–ø –∞—Ç—Ä–∏–±—É—Ç–æ–≤
        attr_groups = {
            "type": "–¢–∏–ø",
            "effect": "–≠—Ñ—Ñ–µ–∫—Ç",
            "finish": "–§–∏–Ω–∏—à",
            "longevity": "–°—Ç–æ–π–∫–æ—Å—Ç—å",
            "color": "–¶–≤–µ—Ç",
            "brush": "–©–µ—Ç–æ—á–∫–∞",
            "price": "–¶–µ–Ω–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è",
            "intensity": "–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å",
            "season": "–°–µ–∑–æ–Ω",
            "texture": "–¢–µ–∫—Å—Ç—É—Ä–∞",
            "shade": "–û—Ç—Ç–µ–Ω–∫–∏"
        }
        
        # –°–ª–æ–≤–∞—Ä—å —Å —ç–º–æ–¥–∑–∏ –¥–ª—è –≥—Ä—É–ø–ø –∞—Ç—Ä–∏–±—É—Ç–æ–≤
        attr_emoji = {
            "type": "üè∑Ô∏è",
            "effect": "‚ú®",
            "finish": "üé®",
            "longevity": "‚è±Ô∏è",
            "color": "üåà",
            "brush": "üñåÔ∏è",
            "price": "üí∞",
            "intensity": "üí™",
            "season": "üçÉ",
            "texture": "üè∑Ô∏è",
            "shade": "üåà"
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã –≤ —Ç–µ–∫—Å—Ç
        for attr_group, attr_value in product['attributes'].items():
            group_name = attr_groups.get(attr_group, attr_group.title())
            emoji = attr_emoji.get(attr_group, "üìã")
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–∞ - —Å–ø–∏—Å–æ–∫
            if isinstance(attr_value, list):
                # –ü–æ–ª—É—á–∞–µ–º —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–∑ ProductCategories
                category_data = getattr(ProductCategories, product['category'].upper(), {})
                group_data = category_data.get(attr_group, {})
                
                # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞
                values = []
                for val in attr_value:
                    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ –µ—Å—Ç—å
                    if val in group_data:
                        values.append(group_data[val])
                    else:
                        values.append(val)
                
                text += f"{emoji} {group_name}: {', '.join(values)}\n"
            else:
                # –ü—Ä–æ—Å—Ç–æ–π —Å–ª—É—á–∞–π - –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ
                category_data = getattr(ProductCategories, product['category'].upper(), {})
                group_data = category_data.get(attr_group, {})
                
                # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                if attr_value in group_data:
                    text += f"{emoji} {group_name}: {group_data[attr_value]}\n"
                else:
                    text += f"{emoji} {group_name}: {attr_value}\n"
    
    return text

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
async def show_recommendations(message_or_callback, products, edit=False, user_id=None):
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    
    Args:
        message_or_callback: –û–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ callback –∑–∞–ø—Ä–æ—Å–∞
        products (list): –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        edit (bool, optional): –ï—Å–ª–∏ True, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ
        user_id (int, optional): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é
    """
    if not products:
        # –ï—Å–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º
        text = "üòû –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é."
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üîç –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏", callback_data="back_to_categories")],
            [InlineKeyboardButton(text="üë®‚Äçüíº –°–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º", callback_data="contact_operator")],
            [InlineKeyboardButton(text="üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
        ])
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if edit and hasattr(message_or_callback, 'message'):
            await message_or_callback.message.edit_text(text, reply_markup=keyboard)
        elif user_id:
            await bot.send_message(user_id, text, reply_markup=keyboard)
        else:
            await message_or_callback.answer(text, reply_markup=keyboard)
        return
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤ —Ç–µ–∫—Å—Ç
    text = "‚ú® <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–∞—Å:</b>\n\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º —Ç–æ–≤–∞—Ä–µ
    for i, product in enumerate(products, 1):
        text += f"<b>{i}.</b> {format_recommendation(product)}\n"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É
    text += "\nüîó –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä –Ω–∞–ø–∏—à–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É –∫–æ–º–∞–Ω–¥–æ–π /send_link c –Ω–æ–º–µ—Ä–æ–º —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞."
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üîÑ –ü–æ–∫–∞–∑–∞—Ç—å –¥—Ä—É–≥–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏", callback_data=f"refresh_recommendations_{products[0]['category']}")],
        [InlineKeyboardButton(text="üîç –ò–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏", callback_data=f"select_category_{products[0]['category']}")],
        [InlineKeyboardButton(text="üë®‚Äçüíº –°–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º", callback_data="contact_operator")],
        [InlineKeyboardButton(text="üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º", callback_data="back_to_categories")]
    ])
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    try:
        if edit and hasattr(message_or_callback, 'message'):
            await message_or_callback.message.edit_text(text, reply_markup=keyboard)
        elif user_id:
            await bot.send_message(user_id, text, reply_markup=keyboard)
        else:
            await message_or_callback.answer(text, reply_markup=keyboard)
    except Exception as e:
        # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {e}")
        
        # –°–æ–∑–¥–∞–µ–º —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –ø–µ—Ä–≤—ã–º–∏ –¥–≤—É–º—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
        short_text = "‚ú® <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–∞—Å:</b>\n\n"
        for i, product in enumerate(products[:2], 1):
            short_text += f"<b>{i}.</b> {format_recommendation(product)}\n"
        
        short_text += "\n‚ö†Ô∏è –¢–µ–∫—Å—Ç –±—ã–ª —Å–æ–∫—Ä–∞—â–µ–Ω –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Telegram.\n"
        short_text += "\nüîó –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä –Ω–∞–ø–∏—à–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É –∫–æ–º–∞–Ω–¥–æ–π /send_link c –Ω–æ–º–µ—Ä–æ–º —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞."
        
        # –ü–æ–≤—Ç–æ—Ä—è–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Å —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
        if edit and hasattr(message_or_callback, 'message'):
            await message_or_callback.message.edit_text(short_text, reply_markup=keyboard)
        elif user_id:
            await bot.send_message(user_id, short_text, reply_markup=keyboard)
        else:
            await message_or_callback.answer(short_text, reply_markup=keyboard)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
async def start_recommendations(callback: types.CallbackQuery, state: FSMContext = None):
    try:
        # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback
        await callback.answer()
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ
        if state:
            await state.clear()
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ —Ç–æ–≤–∞—Ä–æ–≤
        categories_kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üíÑ –ü–æ–º–∞–¥–∞", callback_data="category_lipstick")],
            [InlineKeyboardButton(text="üëÅÔ∏è –¢—É—à—å –¥–ª—è —Ä–µ—Å–Ω–∏—Ü", callback_data="category_mascara")],
            [InlineKeyboardButton(text="üß¥ –ü–∞—Ä—Ñ—é–º", callback_data="category_perfume")],
            [InlineKeyboardButton(text="üå∏ –†—É–º—è–Ω–∞", callback_data="category_blush")],
            [InlineKeyboardButton(text="‚ú® –•–∞–π–ª–∞–π—Ç–µ—Ä", callback_data="category_highlighter")],
            [InlineKeyboardButton(text="üåü –ü—É–¥—Ä–∞", callback_data="category_powder")],
            [InlineKeyboardButton(text="üëÄ –¢–µ–Ω–∏", callback_data="category_eyeshadow")],
            [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="back_to_main")]
        ])
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        await callback.message.edit_text(
            "üîç *–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏*\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–æ–≤, –∏ –º—ã –ø–æ–¥–±–µ—Ä–µ–º –¥–ª—è –≤–∞—Å –ª—É—á—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã!",
            parse_mode="Markdown",
            reply_markup=categories_kb
        )
    except Exception as e:
        logging.error(f"Error in start_recommendations: {e}")
        await callback.message.answer(
            "üòû –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
            ])
        )

async def select_category(callback: types.CallbackQuery, state: FSMContext):
    try:
        # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback
        await callback.answer()
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        category = callback.data.split("_")[1]
        
        # –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        print(f"DEBUG: select_category - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {callback.from_user.id}, –≤—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è {category}")
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ ID, –µ—Å–ª–∏ –∏–º—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
        user_tag = f"@{callback.from_user.username}" if callback.from_user.username else f"ID: {callback.from_user.id}"
        user_name = callback.from_user.full_name
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        await state.update_data(selected_category=category)
        
        # –ü–æ–ª—É—á–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        message = await callback.message.edit_text(
            f"‚ú® *–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è {get_category_name(category)}*\n\n"
            "–û—Ç–º–µ—Ç—å—Ç–µ –≤–∞–∂–Ω—ã–µ –¥–ª—è –≤–∞—Å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ '–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏':",
            parse_mode="Markdown",
            reply_markup=get_category_criteria_keyboard(category)
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        await state.update_data(recommendation_message_id=message.message_id)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–µ –≤ —Å–ª–æ–≤–∞—Ä–µ
        recommendation_requests[callback.from_user.id] = {
            "category": category,
            "message_id": message.message_id,
            "user_tag": user_tag,
            "user_name": user_name
        }
        
        print(f"DEBUG: –°–æ—Ö—Ä–∞–Ω–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ recommendation_requests: {recommendation_requests[callback.from_user.id]}")
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
        await state.set_state(RecommendationState.choosing_criteria)
    except Exception as e:
        logging.error(f"Error in select_category: {e}")
        print(f"DEBUG: –û—à–∏–±–∫–∞ –≤ select_category: {e}")
        await callback.message.answer(
            "üòû –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
            ])
        )

async def toggle_criteria(callback: types.CallbackQuery, state: FSMContext):
    try:
        # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —á–∞—Å—ã –∑–∞–≥—Ä—É–∑–∫–∏
        await callback.answer()
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –∫—Ä–∏—Ç–µ—Ä–∏—è—Ö
        parts = callback.data.split("_")
        category = parts[1]
        criteria_group = parts[2]
        criteria_id = parts[3]
        criteria_key = f"{criteria_group}_{criteria_id}"
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        data = await state.get_data()
        selected_criteria = data.get("selected_criteria", [])
        
        # –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
        print(f"DEBUG: –í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –î–û –∏–∑–º–µ–Ω–µ–Ω–∏—è: {selected_criteria}")
        
        # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫—Ä–∏—Ç–µ—Ä–∏—è (–¥–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ —É–¥–∞–ª—è–µ–º)
        if criteria_key in selected_criteria:
            selected_criteria.remove(criteria_key)
        else:
            selected_criteria.append(criteria_key)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (–í–ê–ñ–ù–û: —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫)
        await state.update_data(selected_criteria=selected_criteria.copy())
        
        # –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        print(f"DEBUG: –í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ü–û–°–õ–ï –∏–∑–º–µ–Ω–µ–Ω–∏—è: {selected_criteria}")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
        try:
            await callback.message.edit_text(
                f"‚ú® *–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è {get_category_name(category)}*\n\n"
                "–û—Ç–º–µ—Ç—å—Ç–µ –≤–∞–∂–Ω—ã–µ –¥–ª—è –≤–∞—Å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ '–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏':",
                parse_mode="Markdown",
                reply_markup=get_category_criteria_keyboard(category, selected_criteria.copy())
            )
        except Exception as e:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å—ë —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            await callback.message.edit_reply_markup(
                reply_markup=get_category_criteria_keyboard(category, selected_criteria.copy())
            )
        
    except Exception as e:
        logging.error(f"Error in toggle_criteria: {e}")
        # –¢–∏—Ö–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

async def reset_criteria(callback: types.CallbackQuery, state: FSMContext):
    try:
        # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback
        await callback.answer("–ö—Ä–∏—Ç–µ—Ä–∏–∏ —Å–±—Ä–æ—à–µ–Ω—ã")
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ callback –¥–∞–Ω–Ω—ã—Ö
        category = callback.data.split("_")[2]
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        await state.update_data(selected_criteria=[])
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å—ë —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
        try:
            await callback.message.edit_text(
                f"‚ú® *–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è {get_category_name(category)}*\n\n"
                "–û—Ç–º–µ—Ç—å—Ç–µ –≤–∞–∂–Ω—ã–µ –¥–ª—è –≤–∞—Å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ '–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏':",
                parse_mode="Markdown",
                reply_markup=get_category_criteria_keyboard(category, [])
            )
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å—ë —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            await callback.message.edit_reply_markup(
                reply_markup=get_category_criteria_keyboard(category, [])
            )
        
    except Exception as e:
        logging.error(f"Error in reset_criteria: {e}")
        # –¢–∏—Ö–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

async def show_recommendations(callback: types.CallbackQuery, state: FSMContext):
    try:
        # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback
        await callback.answer("–ü–æ–¥–±–∏—Ä–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏...")
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        data = await state.get_data()
        category = callback.data.split("_")[2]
        selected_criteria = data.get("selected_criteria", [])
        
        # –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        print(f"DEBUG: –í—ã–±—Ä–∞–Ω—ã –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π: {selected_criteria}")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –ø–æ–¥–±–∏—Ä–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        waiting_message = await callback.message.edit_text(
            "‚è≥ *–ù–∞—à–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—ã –ø–æ–¥–±–∏—Ä–∞—é—Ç –¥–ª—è –≤–∞—Å –ª—É—á—à–∏–µ —Ç–æ–≤–∞—Ä—ã*\n\n"
            "–≠—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ú—ã —É—á—Ç–µ–º –≤—Å–µ –≤–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏ –ø–æ–¥–±–µ—Ä–µ–º –∏–¥–µ–∞–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã.",
            parse_mode="Markdown",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üîô –ò–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏", callback_data=f"category_{category}")],
                [InlineKeyboardButton(text="üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
            ])
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_id = callback.from_user.id
        message_id = waiting_message.message_id
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
        user_info = callback.from_user
        username = user_info.username if user_info.username else "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        full_name = user_info.full_name
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        criteria_text = ""
        for criteria_key in selected_criteria:
            parts = criteria_key.split('_')
            if len(parts) == 2:
                group, value = parts
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏—è
                category_data = getattr(ProductCategories, category.upper(), {})
                if group in category_data and value in category_data[group]:
                    criteria_description = category_data[group][value]
                    criteria_text += f"- {group.title()}: {criteria_description}\n"
        
        if not criteria_text:
            criteria_text = "–ö—Ä–∏—Ç–µ—Ä–∏–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã"
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ —Å username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        operator_message = (
            f"üîî *–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏*\n\n"
            f"–û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {full_name} (ID: {user_id})\n"
            f"Username: @{username}\n"
            f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è: *{get_category_name(category)}*\n\n"
            f"–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏:\n{criteria_text}\n\n"
            f"–î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Å—ã–ª–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É:\n"
            f"`/send_link {user_id} [—Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä]`"
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
        from main import bot
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
        try:
            await bot.send_message(
                chat_id=OPERATOR_CHAT_ID,
                text=operator_message,
                parse_mode="Markdown"
            )
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–µ
            recommendation_requests[user_id] = {
                "message_id": message_id,
                "category": category,
                "criteria": selected_criteria,
                "waiting_since": asyncio.get_event_loop().time()
            }
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
            await state.set_state(RecommendationState.waiting_for_operator_reply)
            await state.update_data(
                waiting_message_id=message_id,
                category=category,
                selected_criteria=selected_criteria
            )
            
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É: {e}")
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –æ–ø–µ—Ä–∞—Ç–æ—Ä—É, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            advanced_system = AdvancedRecommendationSystem()
            recommendations = advanced_system.get_recommendations(category, selected_criteria)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            await send_auto_recommendations(callback.message, category, recommendations)
            await state.clear()
        
    except Exception as e:
        logging.error(f"Error in show_recommendations: {e}")
        await callback.message.answer(
            "üòû –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–±–æ—Ä–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
            ])
        )

async def send_auto_recommendations(message, category, recommendations):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"""
    try:
        # –ï—Å–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–µ—Ç, —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º
        if not recommendations:
            await message.edit_text(
                "üòî –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤.\n\n"
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é.",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥ –∫ –∫—Ä–∏—Ç–µ—Ä–∏—è–º", callback_data=f"category_{category}")],
                    [InlineKeyboardButton(text="üîô –ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º", callback_data="recommend_products")],
                    [InlineKeyboardButton(text="üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
                ])
            )
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
        text = "‚ú® *–í–æ—Ç —á—Ç–æ –º—ã –≤–∞–º —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º:*\n\n"
        
        for i, product in enumerate(recommendations, 1):
            text += f"*{i}. {product['name']}*\n"
            text += f"üí∞ –¶–µ–Ω–∞: {product['price']} —Ä—É–±.\n"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã —Ç–æ–≤–∞—Ä–∞
            if 'attributes' in product:
                for attr_type, attr_value in product['attributes'].items():
                    if isinstance(attr_value, list):
                        attr_value = ", ".join(attr_value)
                    text += f"- {attr_type.capitalize()}: {attr_value}\n"
            
            text += "\n"
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π –ø–æ—Å–ª–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üîç –ü–æ–¥–æ–±—Ä–∞—Ç—å –µ—â—ë", callback_data=f"category_{category}")],
            [InlineKeyboardButton(text="üìù –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", callback_data="order")],
            [InlineKeyboardButton(text="üîô –ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º", callback_data="recommend_products")],
            [InlineKeyboardButton(text="üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
        ])
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
        await message.edit_text(
            text,
            parse_mode="Markdown",
            reply_markup=keyboard
        )
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: {e}")

async def test_send_link(message: types.Message):
    """–¢–µ—Å—Ç–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /send_link –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å—Å—ã–ª–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
    try:
        # –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Å–æ–ª—å)
        print(f"DEBUG: test_send_link –ø–æ–ª—É—á–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ. ID —á–∞—Ç–∞: {message.chat.id}, –¢–µ–∫—Å—Ç: {message.text}")
        logging.info(f"test_send_link –ø–æ–ª—É—á–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ: {message.text}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–º–∞–Ω–¥—ã
        parts = message.text.split(' ', 2)
        if len(parts) < 3:
            await message.reply(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã.\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: `/send_link USER_ID –°–°–´–õ–ö–ê [–û–ü–ò–°–ê–ù–ò–ï]`",
                parse_mode="Markdown"
            )
            return
        
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        try:
            user_id = int(parts[1])
            link = parts[2].split(' ')[0]
            description = ""
            if len(parts[2].split(' ')) > 1:
                description = ' '.join(parts[2].split(' ')[1:])
            
            # –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            print(f"DEBUG: –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id} —Å —Å—Å—ã–ª–∫–æ–π {link}")
            
            # –ò–º–ø–æ—Ä—Ç –±–æ—Ç–∞
            from main import bot
            
            # –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üåê –ü–µ—Ä–µ–π—Ç–∏ –ø–æ —Å—Å—ã–ª–∫–µ", url=link)],
                [InlineKeyboardButton(text="üîç –ü–æ–¥–æ–±—Ä–∞—Ç—å –¥—Ä—É–≥–∏–µ —Ç–æ–≤–∞—Ä—ã", callback_data="recommend_products")],
                [InlineKeyboardButton(text="üìù –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", callback_data="order")],
                [InlineKeyboardButton(text="üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
            ])
            
            # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            text = (
                "‚ú® *–ù–∞—à –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ–¥–æ–±—Ä–∞–ª –¥–ª—è –≤–∞—Å –∏–¥–µ–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:*\n\n"
                f"[–ù–∞–∂–º–∏—Ç–µ –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–≤–∞—Ä]({link})\n\n"
            )
            
            if description:
                text += f"üí¨ *–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞:*\n{description}\n\n"
            
            text += "–í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –ø–æ —Å—Å—ã–ª–∫–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç."
            
            # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            sent_message = await bot.send_message(
                chat_id=user_id,
                text=text,
                parse_mode="Markdown",
                reply_markup=keyboard,
                disable_web_page_preview=False
            )
            
            print(f"DEBUG: –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. ID —Å–æ–æ–±—â–µ–Ω–∏—è: {sent_message.message_id}")
            
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            await message.reply(
                f"‚úÖ –°—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}",
                parse_mode="Markdown"
            )
            
        except ValueError:
            await message.reply(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID.",
                parse_mode="Markdown"
            )
        except Exception as e:
            print(f"DEBUG: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å—Å—ã–ª–∫–∏: {e}")
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å—Å—ã–ª–∫–∏: {e}")
            await message.reply(
                f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: {e}",
                parse_mode="Markdown"
            )
    except Exception as e:
        print(f"DEBUG: –û–±—â–∞—è –æ—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ: {e}")
        logging.error(f"–û–±—â–∞—è –æ—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ: {e}")
        await message.reply(
            f"‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞: {e}",
            parse_mode="Markdown"
        )

# –î–æ–±–∞–≤–∏–º —Ç–µ—Å—Ç–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ test_send_link
async def send_link_test(message: types.Message):
    """–°–≤–µ—Ä—Ö–ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    try:
        print(f"DEBUG: [send_link_test] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: {message.text}")
        
        # –†–∞–∑–±–æ—Ä –∫–æ–º–∞–Ω–¥—ã
        parts = message.text.split(' ', 2)
        if len(parts) < 3:
            await message.reply("‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /send_link_test ID –°–°–´–õ–ö–ê")
            return
        
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        user_id = parts[1]
        link = parts[2]
        
        print(f"DEBUG: [send_link_test] ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_id}, —Å—Å—ã–ª–∫–∞: {link}")
        
        # –ò–º–ø–æ—Ä—Ç –±–æ—Ç–∞
        from main import bot
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä—è–º–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        sent_message = await bot.send_message(
            chat_id=user_id,
            text=f"–¢–µ—Å—Ç–æ–≤–∞—è —Å—Å—ã–ª–∫–∞: {link}"
        )
        
        print(f"DEBUG: [send_link_test] –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, ID: {sent_message.message_id}")
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
        await message.reply(f"‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        
    except Exception as e:
        print(f"DEBUG: [send_link_test] –û–®–ò–ë–ö–ê: {e}")
        await message.reply(f"‚ùå –û—à–∏–±–∫–∞: {e}")

def get_category_name(category: str) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Ä—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤"""
    categories = {
        "lipstick": "–ø–æ–º–∞–¥—ã",
        "mascara": "—Ç—É—à–∏ –¥–ª—è —Ä–µ—Å–Ω–∏—Ü",
        "perfume": "–ø–∞—Ä—Ñ—é–º–∞",
        "blush": "—Ä—É–º—è–Ω",
        "highlighter": "—Ö–∞–π–ª–∞–π—Ç–µ—Ä–∞",
        "powder": "–ø—É–¥—Ä—ã",
        "eyeshadow": "—Ç–µ–Ω–µ–π"
    }
    return categories.get(category, category)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
def register_handlers(dp: Dispatcher):
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    init_db()
    
    # –ü–æ–ª—É—á–∞–µ–º ID —á–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏–∑ main.py
    global OPERATOR_CHAT_ID
    from main import OPERATOR_CHAT_ID as MAIN_OPERATOR_CHAT_ID
    OPERATOR_CHAT_ID = MAIN_OPERATOR_CHAT_ID
    
    print(f"DEBUG: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π, OPERATOR_CHAT_ID={OPERATOR_CHAT_ID}")
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –ü–ï–†–í–´–ú –≤ —Å–ø–∏—Å–∫–µ
    dp.message(lambda message: message.text and message.text.startswith("/debug_send"))(debug_send_message)
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    dp.message(lambda message: message.text and message.text.startswith("/send_link_test"))(send_link_test)
    dp.message(lambda message: message.text and message.text.startswith("/send_link"))(test_send_link)
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
    dp.callback_query(lambda c: c.data == "product_recommendations")(start_recommendations)
    dp.callback_query(lambda c: c.data == "recommend_products")(start_recommendations)
    dp.callback_query(lambda c: c.data.startswith("category_"))(select_category)
    dp.callback_query(lambda c: c.data.startswith("criteria_"))(toggle_criteria)
    dp.callback_query(lambda c: c.data.startswith("header_"))(lambda c: c.answer("–≠—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"))
    dp.callback_query(lambda c: c.data.startswith("reset_criteria_"))(reset_criteria)
    dp.callback_query(lambda c: c.data.startswith("show_recommendations_"))(show_recommendations)
    dp.callback_query(lambda c: c.data == "back_to_categories")(start_recommendations)

async def process_category_selection(callback: types.CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤"""
    try:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ callback_data
        category = callback.data.split('_')[1]
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        user_data = await state.get_data()
        
        # –ü–æ–ª—É—á–∞–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        message_id = user_data.get('recommendation_message_id', callback.message.message_id)
        
        print(f"DEBUG: process_category_selection - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {callback.from_user.id}, –∫–∞—Ç–µ–≥–æ—Ä–∏—è {category}, message_id {message_id}")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ callback, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        await callback.answer()
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ ID, –µ—Å–ª–∏ –∏–º—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
        user_tag = f"@{callback.from_user.username}" if callback.from_user.username else f"ID: {callback.from_user.id}"
        user_name = callback.from_user.full_name
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–µ
        recommendation_requests[callback.from_user.id] = {
            "category": category,
            "message_id": message_id,
            "message": callback.message,
            "user_tag": user_tag,
            "user_name": user_name
        }
        
        print(f"DEBUG: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ recommendation_requests: {recommendation_requests[callback.from_user.id]}")
        logging.info(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: user_id={callback.from_user.id}, category={category}, message_id={message_id}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        operator_message = (
            f"üîî *–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥–±–æ—Ä —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π*\n\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_name} ({user_tag})\n"
            f"üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: *{category}*\n\n"
            f"*–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*\n"
            f"–î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É:\n"
            f"`/send_link {callback.from_user.id} –°–°–´–õ–ö–ê [–û–ø–∏—Å–∞–Ω–∏–µ]`\n\n"
            f"–ü—Ä–∏–º–µ—Ä: `/send_link {callback.from_user.id} https://example.com/product –û—Ç–ª–∏—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç!`"
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
        from main import bot
        await bot.send_message(
            chat_id=OPERATOR_CHAT_ID,
            text=operator_message,
            parse_mode="Markdown"
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ —Ç–æ–º, —á—Ç–æ –µ–≥–æ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç
        await callback.message.edit_text(
            "‚è≥ *–í–∞—à –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥–±–æ—Ä —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø—Ä–∏–Ω—è—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É!*\n\n"
            f"–í—ã –≤—ã–±—Ä–∞–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é: *{category}*\n\n"
            "–ù–∞—à –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Å–∫–æ—Ä–æ –ø–æ–¥–±–µ—Ä–µ—Ç –¥–ª—è –≤–∞—Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∏ –ø—Ä–∏—à–ª–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä. "
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –≤ —á–∞—Ç–µ.",
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
            ]),
            parse_mode="Markdown"
        )
        
    except Exception as e:
        print(f"DEBUG: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {e}")
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {e}")
        await callback.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.")
        
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            await callback.message.edit_text(
                "üòû –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                reply_markup=InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
                ])
            )
        except Exception as edit_error:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ: {edit_error}") 

async def debug_send_message(message: types.Message):
    """–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    try:
        print(f"DEBUG: [debug_send_message] –ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: {message.text}")
        
        # –†–∞–∑–±–æ—Ä –∫–æ–º–∞–Ω–¥—ã
        parts = message.text.split(' ', 2)
        if len(parts) < 3:
            await message.reply("‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /debug_send USER_ID –¢–ï–ö–°–¢")
            return
            
        # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        user_id = parts[1]
        text_message = parts[2]
        
        print(f"DEBUG: [debug_send_message] ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_id}, —Ç–µ–∫—Å—Ç: {text_message}")
        
        # –û—Ç–≤–µ—á–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
        await message.reply(f"üëç –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}...")
        
        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–æ—Ç –Ω–∞–ø—Ä—è–º—É—é
        from main import bot
        
        try:
            # –ó–∞–ø—Ä–æ—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –µ–≥–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
            try:
                print(f"DEBUG: [debug_send_message] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
                user_info = await bot.get_chat(user_id)
                print(f"DEBUG: [debug_send_message] –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: {user_info.id}, {user_info.type}")
            except Exception as user_error:
                print(f"DEBUG: [debug_send_message] –û–®–ò–ë–ö–ê –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: {user_error}")
                await message.reply(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ {user_id}: {user_error}")
                return
                
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±–æ—Ç–∞
            try:
                print(f"DEBUG: [debug_send_message] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
                chat_member = await bot.get_chat_member(user_id, bot.id)
                print(f"DEBUG: [debug_send_message] –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –±–æ—Ç–∞: {chat_member.status}")
            except Exception as perm_error:
                print(f"DEBUG: [debug_send_message] –û–®–ò–ë–ö–ê –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π: {perm_error}")
                # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤
            
            # –ü–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–ø - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ —Ä–∞–∑–º–µ—Ç–∫–∏ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
            try:
                print(f"DEBUG: [debug_send_message] –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
                sent_message = await bot.send_message(
                    chat_id=user_id,
                    text=f"–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {text_message}"
                )
                print(f"DEBUG: [debug_send_message] –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! ID: {sent_message.message_id}")
                await message.reply(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}!")
            except Exception as send_error:
                print(f"DEBUG: [debug_send_message] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: {send_error}")
                await message.reply(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {send_error}")
        
        except Exception as bot_error:
            print(f"DEBUG: [debug_send_message] –û–®–ò–ë–ö–ê –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–æ—Ç–æ–º: {bot_error}")
            await message.reply(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–æ—Ç–æ–º: {bot_error}")
        
    except Exception as global_error:
        print(f"DEBUG: [debug_send_message] –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –û–®–ò–ë–ö–ê: {global_error}")
        try:
            await message.reply(f"‚ùå –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: {global_error}")
        except:
            print("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ!") 