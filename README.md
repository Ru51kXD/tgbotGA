# GoldenAppleBot - Документация

## Обзор проекта

GoldenAppleBot - это Telegram бот для магазина косметики, позволяющий пользователям получать рекомендации товаров, оформлять заказы, просматривать акции и получать поддержку от операторов.

## Структура проекта

Проект состоит из нескольких модулей:

- `main.py` - основной файл с точкой входа и инициализацией бота
- `recommendations.py` - система рекомендаций товаров
- `main_menu.py` - модуль главного меню
- `akcii.py` - модуль акций и специальных предложений
- `order_cancel.py` - функционал отмены заказов
- `order_status.py` - проверка статуса заказов
- `how_to_order.py` - инструкции по оформлению заказов
- `gift_cards.py` - функционал подарочных карт
- `missing_card.py` - обработка отсутствующих карт лояльности
- `support.py` - функции поддержки пользователей через операторов

## Установка и запуск

### Требования
- Python 3.7+
- aiogram 3.x
- SQLite3
- pandas
- python-dotenv

### Установка
```bash
pip install aiogram pandas python-dotenv
```

### Настройка
1. Создайте файл `.env` в корне проекта
2. Добавьте следующие переменные:
```
BOT_TOKEN=ваш_токен_от_BotFather
OPERATOR_CHAT_ID=id_чата_операторов
```

### Запуск
```bash
python main.py
```

## Основные компоненты

### main.py

Основной файл бота, который содержит инициализацию и запуск.

#### Основные функции:
- `main()` - основная асинхронная функция для запуска бота
- `diagnostic_send()` - диагностическая функция для проверки отправки сообщений
- `diagnostic_command()` - обработчик команды /diagnostic
- `on_startup()` - функция, выполняемая при запуске бота
- `test_direct_message()` - функция для прямой отправки сообщений пользователям (для тестирования)
- `register_all_handlers()` - регистрация всех обработчиков из подключаемых модулей

### recommendations.py

Модуль рекомендаций товаров для пользователей.

#### Классы:

##### RecommendationState
Класс для управления состояниями пользователя в процессе получения рекомендаций.

```python
class RecommendationState(StatesGroup):
    choosing_category = State()  # Состояние выбора категории
    waiting_for_criteria = State()  # Ожидание критериев
    choosing_criteria = State()  # Выбор критериев
    waiting_for_operator_reply = State()  # Ожидание ответа оператора
```

##### ProductCategories
Содержит структурированные данные о категориях товаров и их атрибутах.

```python
class ProductCategories:
    MASCARA = {...}  # Данные о тушах
    LIPSTICK = {...}  # Данные о помадах
    PERFUME = {...}   # Данные о парфюмах
```

##### RecommendationSystem
Базовая система рекомендаций, работающая с базой данных товаров.

Методы:
- `__init__()` - инициализация системы
- `_load_from_db()` - загрузка товаров из БД
- `_refresh_data()` - обновление данных
- `get_recommendations()` - получение рекомендаций
- Различные стратегии рекомендаций (`_popularity_based`, `_price_based`, `_category_based`, `_random_mix`)

##### AdvancedRecommendationSystem
Расширенная система рекомендаций с учетом критериев пользователя.

Методы:
- `get_recommendations()` - получение рекомендаций по категории и критериям
- `_parse_results()` - обработка результатов запроса
- `_filter_by_attributes()` - фильтрация товаров по атрибутам
- `_calculate_relevance_score()` - вычисление релевантности товара запросу пользователя

#### Основные функции:

##### Инициализация и утилиты:
- `init_db()` - создание/проверка базы данных товаров
- `get_category_criteria_keyboard()` - формирование клавиатуры с критериями
- `get_user_data()` - получение данных пользователя
- `get_category_name()` - получение названия категории на русском
- `format_product_text()` - форматирование описания товара для отображения

##### Обработчики сообщений и команд:
- `start_recommendations()` - начало процесса рекомендаций
- `select_category()` - обработка выбора категории
- `toggle_criteria()` - включение/выключение критерия
- `reset_criteria()` - сброс критериев
- `show_recommendations()` - отображение рекомендаций
- `send_auto_recommendations()` - автоматические рекомендации
- `back_to_categories()` - возврат к выбору категорий

##### Функции для отправки сообщений:
- `test_send_link()` - отправка рекомендаций пользователю через оператора
- `send_link_test()` - тестовая отправка сообщения пользователю
- `debug_send_message()` - диагностика отправки сообщений
- `notify_operator()` - отправка уведомления оператору о запросе рекомендаций

##### Регистрация обработчиков:
- `register_handlers()` - регистрация всех обработчиков сообщений и callback-запросов

### main_menu.py

Модуль главного меню, содержащий структуру и обработчики для основного интерфейса бота.

#### Основные функции:
- `show_main_menu()` - отображение главного меню
- `start_command()` - обработчик команды /start
- `help_command()` - обработчик команды /help
- `back_to_main_menu()` - обработчик возвращения в главное меню
- `register_handlers()` - регистрация обработчиков главного меню
- `create_main_menu_keyboard()` - создание клавиатуры главного меню

### order_cancel.py

Модуль для обработки отмены заказов.

#### Классы:
- `OrderState` - состояния процесса отмены заказа

#### Основные функции:
- `cancel_order_menu()` - меню отмены заказа
- `order_cancellation_handler()` - обработчик процесса отмены
- `process_order_number()` - обработка номера заказа
- `confirm_cancellation()` - подтверждение отмены
- `decline_cancellation()` - отказ от отмены
- `validate_order_number()` - проверка корректности номера заказа
- `get_order_info()` - получение информации о заказе
- `cancel_order_in_db()` - отмена заказа в базе данных
- `notify_about_cancellation()` - уведомление об отмене заказа

### order_status.py

Модуль для проверки статуса заказов.

#### Классы:
- `OrderStatusState` - состояния процесса проверки статуса

#### Основные функции:
- `start_order_status_check()` - начало проверки статуса
- `process_order_number_for_status()` - обработка номера заказа для проверки
- `show_order_status()` - отображение статуса заказа
- `order_status_help()` - помощь по проверке статуса
- `get_order_details()` - получение подробной информации о заказе
- `format_order_info()` - форматирование информации о заказе

### gift_cards.py

Модуль для работы с подарочными картами.

#### Основные функции:
- `show_gift_cards_menu()` - отображение меню подарочных карт
- `show_physical_gift_cards()` - информация о физических подарочных картах
- `show_digital_gift_cards()` - информация о цифровых подарочных картах
- `show_how_to_use_gift_card()` - инструкция по использованию подарочной карты
- `show_gift_card_balance()` - проверка баланса подарочной карты
- `process_gift_card_number()` - обработка номера подарочной карты

### support.py

Модуль для обработки сообщений поддержки и связи с операторами.

#### Основные функции:
- `start_support()` - начало диалога с поддержкой
- `handle_user_message()` - обработка сообщений пользователя
- `handle_operator_message()` - обработка сообщений оператора
- `connect_operator()` - подключение оператора к диалогу
- `disconnect_operator()` - отключение оператора от диалога
- `forward_message_to_operator()` - пересылка сообщения оператору
- `forward_message_to_user()` - пересылка сообщения пользователю
- `notify_operator_about_new_support_request()` - уведомление оператора о новом запросе
- `save_support_history()` - сохранение истории диалога поддержки
- `close_support_ticket()` - закрытие тикета поддержки

## Работа с базой данных

Бот использует SQLite для хранения информации о товарах. База данных инициализируется при первом запуске и содержит демо-данные.

### Структура таблицы `products`:
- `id` - уникальный идентификатор товара
- `name` - название товара
- `category` - категория (mascara, lipstick, perfume)
- `price` - цена
- `rating` - рейтинг
- `attributes` - JSON с атрибутами товара

### Структура таблицы `orders`:
- `id` - уникальный идентификатор заказа
- `user_id` - ID пользователя
- `status` - статус заказа
- `created_at` - дата и время создания
- `updated_at` - дата и время обновления
- `products` - JSON с информацией о заказанных товарах
- `total_price` - общая цена заказа
- `delivery_info` - информация о доставке

### Структура таблицы `support_chats`:
- `id` - уникальный идентификатор
- `user_id` - ID пользователя
- `operator_id` - ID оператора
- `status` - статус чата
- `created_at` - дата и время создания
- `last_activity` - последняя активность
- `subject` - тема обращения

## Дополнительные функции и модули

### Обработка платежей
Бот имеет функциональность для обработки платежей с помощью API Telegram Payments.

Функции:
- `start_checkout()` - начало процесса оформления заказа
- `process_pre_checkout_query()` - обработка предварительного запроса оплаты
- `process_successful_payment()` - обработка успешного платежа
- `send_invoice()` - отправка счета пользователю
- `generate_payment_link()` - генерация ссылки для оплаты

### Система нотификаций
Бот отправляет уведомления пользователям и операторам о важных событиях.

Функции:
- `notify_user_about_order_status()` - уведомление пользователя о статусе заказа
- `send_promotional_notification()` - отправка промо-уведомлений
- `send_scheduled_notification()` - отправка запланированных уведомлений
- `remind_about_abandoned_cart()` - напоминание о незавершённом заказе

### Аналитика и статистика
Бот собирает статистику о пользователях и их взаимодействиях.

Функции:
- `collect_user_activity()` - сбор данных об активности пользователя
- `generate_daily_report()` - создание ежедневного отчета
- `track_message_response_time()` - отслеживание времени ответа на сообщения
- `analyze_product_popularity()` - анализ популярности товаров

## Процесс получения рекомендаций

1. Пользователь выбирает категорию товаров (тушь, помада, парфюм)
2. Система предлагает выбрать критерии для товара (цвет, стойкость, финиш и т.д.)
3. После выбора критериев запрос отправляется оператору с указанием ID пользователя и выбранных критериев
4. Оператор подбирает товар и отправляет ссылку пользователю с помощью команды `/send_link`
5. Если оператор недоступен, система генерирует автоматические рекомендации на основе критериев

## Процесс оформления заказа

1. Пользователь выбирает опцию "Оформить заказ"
2. Система предлагает выбрать товары из каталога или использовать рекомендации
3. Пользователь добавляет товары в корзину
4. Система предлагает выбрать способ доставки:
   - Доставка по адресу
   - Самовывоз из магазина
   - Постамат/пункт выдачи
5. Пользователь указывает адрес доставки или выбирает пункт самовывоза
6. Система предлагает выбрать способ оплаты:
   - Оплата картой онлайн
   - Оплата при получении
   - Оплата подарочной картой
7. После подтверждения заказа система генерирует уникальный номер заказа
8. Пользователь получает сообщение с информацией о заказе и ссылкой для оплаты (если выбрана онлайн-оплата)

## Процесс отмены заказа

1. Пользователь выбирает опцию "Отменить заказ"
2. Система запрашивает номер заказа
3. Пользователь вводит номер заказа
4. Система предлагает подтвердить отмену
5. При подтверждении заказ отменяется, и пользователь получает подтверждение
6. Система отправляет уведомление в систему управления магазином о необходимости отмены заказа

## Интеграция с внешними системами

### API магазина
Бот интегрирован с API магазина для получения актуальной информации о товарах, ценах и акциях.

Функции:
- `sync_products_data()` - синхронизация данных о товарах
- `update_prices()` - обновление цен
- `check_stock_availability()` - проверка наличия товаров на складе
- `get_product_details()` - получение подробной информации о товаре

### CRM-система
Интеграция с CRM-системой для работы с заказами и клиентами.

Функции:
- `create_order_in_crm()` - создание заказа в CRM-системе
- `update_order_status()` - обновление статуса заказа
- `add_customer_to_crm()` - добавление клиента в CRM
- `get_order_history()` - получение истории заказов клиента

### Система доставки
Интеграция с сервисами доставки для отслеживания отправлений.

Функции:
- `calculate_delivery_cost()` - расчет стоимости доставки
- `get_delivery_points()` - получение пунктов выдачи
- `track_package()` - отслеживание посылки
- `generate_delivery_label()` - создание этикетки для отправления

## Команды для операторов

- `/send_link [ID пользователя] [ссылка] [описание]` - отправка ссылки на товар пользователю
- `/debug_send [ID пользователя] [текст]` - диагностическая команда для проверки связи
- `/diagnostic [ID пользователя]` - диагностика отправки сообщений
- `/broadcast [сообщение]` - рассылка сообщения всем пользователям
- `/stats` - получение статистики использования бота
- `/find_user [ID/имя]` - поиск пользователя
- `/block_user [ID]` - блокировка пользователя
- `/get_order [номер]` - получение информации о заказе

## Отладка и диагностика

В коде предусмотрены многочисленные отладочные сообщения, которые выводятся в консоль:
- При получении команд
- При выборе категорий и критериев
- При отправке сообщений
- При возникновении ошибок

Для диагностики проблем с отправкой сообщений используйте команду `/diagnostic`.

### Диагностические файлы:
- `bot_log.txt` - основной лог работы бота
- `error_log.txt` - лог ошибок
- `api_requests.log` - лог запросов к внешним API
- `user_actions.log` - лог действий пользователей

## Стратегии рекомендаций

1. **Популярность** - товары с лучшим рейтингом
2. **Цена** - товары в ценовом диапазоне пользователя 
3. **Категория** - товары из предпочитаемых категорий
4. **Случайный выбор** - случайная выборка товаров
5. **Персонализированные рекомендации** - на основе предыдущих покупок и просмотров
6. **Новинки** - недавно добавленные товары
7. **Похожие товары** - товары, похожие на те, что интересовали пользователя
8. **Сезонные рекомендации** - товары, актуальные для текущего сезона

## Пользовательский интерфейс

Интерфейс бота построен на основе встроенных кнопок и меню Telegram:

1. **Главное меню**:
   - Подобрать товар
   - Проверить статус заказа
   - Акции и скидки
   - Как оформить заказ
   - Подарочные карты
   - Нет карты лояльности
   - Поддержка

2. **Меню рекомендаций**:
   - Выбор категории
   - Выбор критериев
   - Получение рекомендаций

3. **Меню поддержки**:
   - Связь с оператором
   - Часто задаваемые вопросы

4. **Меню заказа**:
   - Корзина
   - Оформление заказа
   - История заказов
   - Отмена заказа

5. **Меню аккаунта**:
   - Личная информация
   - Сохраненные адреса
   - Программа лояльности
   - Бонусные баллы

## Администрирование бота

Для администрирования бота предусмотрен веб-интерфейс, доступный по отдельной ссылке. В нем можно:
- Просматривать статистику использования
- Управлять пользователями
- Настраивать параметры рекомендаций
- Редактировать тексты сообщений
- Управлять базой данных товаров
- Мониторить работу внешних интеграций
- Просматривать логи и отчеты

## Типичные проблемы и их решения

1. **Бот не отвечает** - проверьте подключение к интернету и доступность API Telegram
2. **Ошибка при отправке сообщений** - проверьте правильность ID пользователя и используйте команду `/diagnostic`
3. **Конфликты между экземплярами бота** - убедитесь, что запущен только один экземпляр бота
4. **Проблемы с отправкой ссылок от оператора** - используйте команды `/debug_send` и `/diagnostic` для диагностики
5. **Ошибки в рекомендациях** - проверьте структуру базы данных, особенно поле `attributes`
6. **Проблемы с сохранением состояния диалога** - проверьте работу MemoryStorage и отключите режим отладки в настройках бота
7. **Ошибки при работе с внешними API** - проверьте доступность сервисов и правильность API-ключей
8. **Медленная работа бота** - оптимизируйте запросы к базе данных и уменьшите количество внешних API-вызовов

## Расширение функциональности

Для добавления новых функций:
1. Создайте новый модуль или расширьте существующий
2. Добавьте обработчики сообщений или callback-запросов
3. Зарегистрируйте обработчики в функции register_handlers()
4. Добавьте новые состояния в соответствующий класс StatesGroup

### Примеры расширений:
- Интеграция с системой отзывов о товарах
- Добавление чат-бота на базе нейросетей для автоматических ответов
- Реализация системы скидочных купонов
- Добавление возможности загрузки фото пользователем для подбора косметики

## Архитектура бота

Бот построен на основе библиотеки aiogram 3.x с использованием:
- Машины состояний (FSM) для управления диалогами
- Callback-запросов для обработки нажатий на кнопки
- Встроенных клавиатур для создания пользовательского интерфейса
- Асинхронного программирования для эффективной обработки запросов

### Структура проекта:
```
tgbot/
├── main.py              # Основной файл бота
├── .env                 # Файл с переменными окружения
├── recommendations.py   # Система рекомендаций
├── main_menu.py         # Главное меню
├── order_cancel.py      # Отмена заказов
├── order_status.py      # Статус заказов
├── how_to_order.py      # Инструкции по заказу
├── gift_cards.py        # Подарочные карты
├── missing_card.py      # Отсутствующие карты
├── support.py           # Поддержка пользователей
├── utils/               # Вспомогательные функции
│   ├── database.py      # Работа с базой данных
│   ├── api_client.py    # Клиент для работы с API
│   ├── keyboards.py     # Функции создания клавиатур
│   └── formatters.py    # Форматирование сообщений
├── data/                # Данные и ресурсы
│   ├── recommendations.db   # База данных товаров
│   └── images/          # Изображения для бота
└── logs/                # Логи работы бота
```

## Безопасность

1. Токен бота хранится в переменных окружения
2. ID чата операторов проверяется при отправке команд
3. Реализована проверка входных данных от пользователей
4. Предусмотрена обработка исключений для предотвращения сбоев
5. Ограничение доступа к административным функциям
6. Шифрование чувствительных данных
7. Регулярное создание резервных копий базы данных
8. Защита от спама с помощью ограничения частоты запросов

## Разработка и тестирование

При разработке новых функций рекомендуется:
1. Добавлять подробное логирование для отладки
2. Тестировать функциональность в отдельном тестовом боте
3. Использовать диагностические команды для проверки работы отправки сообщений
4. Обрабатывать все возможные исключения

### Среда тестирования:
- Тестовый бот с отдельным токеном
- Тестовая база данных
- Моки для внешних API
- Автоматизированные тесты для основных сценариев

## Масштабирование бота

Для работы с большим количеством пользователей:
1. Перенесите базу данных на выделенный сервер PostgreSQL
2. Используйте Redis для хранения состояний диалогов
3. Реализуйте балансировку нагрузки с несколькими экземплярами бота
4. Оптимизируйте запросы к внешним системам
5. Внедрите кэширование результатов запросов
6. Используйте очереди для асинхронной обработки длительных операций

## История изменений

### Версия 1.0.0
- Первоначальный релиз с базовой функциональностью

### Версия 1.1.0
- Добавлена система рекомендаций
- Улучшен пользовательский интерфейс

### Версия 1.2.0
- Интеграция с API магазина
- Добавлены функции работы с заказами

### Версия 1.3.0
- Расширенная система поддержки
- Диагностические инструменты
- Исправления ошибок при отправке сообщений

## Контакты для связи

При возникновении вопросов или проблем с ботом обращайтесь к разработчику. 